@if (!matchedQuestion) {
<div class="content has-text-centered has-text-light">
    <span class="icon is-large">
        <fa-icon [icon]="faCircleNotch" [spin]="true" size="4x"></fa-icon>
    </span>
</div>
}
@else {
<div class="question-header" (click)="toggleQuestion()" [ngClass]="{'is-loading': loading}">
    <h2 class="subtitle is-4 mb-4 has-text-weight-semibold">
        <div class="level">
            <div class="level-left">
                <span class="expand-button icon-text" [ngClass]="{'expanded': questionExpanded}">
                    <span class="icon">
                        <fa-icon [icon]="faChevronDown"></fa-icon>
                    </span>
                    <span [innerHTML]="matchedQuestion.prompt | highlight"></span>
                </span>
            </div>
            <div class="level-right question-filters">
                <div class="field has-addons">
                    <p class="control">
                        <button class="button is-success is-light-or-dark" (click)="onFilterSelected($event, 'id', id)">
                            <span class="icon">
                                <fa-icon [icon]="faCheck"></fa-icon>
                            </span>
                            <span i18n>Select</span>
                        </button>
                    </p>
                    <p class="control">
                        <button class="button is-danger is-light-or-dark" (click)="onExcludeFilter($event, 'id', id)">
                            <span class="icon">
                                <fa-icon [icon]="faTimes"></fa-icon>
                            </span>
                            <span i18n>Exclude</span>
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </h2>
</div>
<div class="box metadata" [ngClass]="{'is-loading': loading}">
    @if (questionExpanded) {
    <luu-view>
        <luu-line type="example" [value]="matchedQuestion.prompt.highlightedText"></luu-line>
        <luu-line type="gloss" [value]="matchedQuestion.gloss.highlightedText"></luu-line>
        <luu-translation [innerHTML]="matchedQuestion.en_translation | highlight"></luu-translation>
    </luu-view>
    <hr class="mt-2 mb-2" />
    }
    <div class="fixed-grid has-11-cols has-1-cols-mobile">
        <div class="grid">
            <div class="cell is-col-span-3">
                <span i18n>
                    {{ matchedDialectsCount }} of {{ dialectsCount }} dialects matched
                </span>
            </div>
            <div class="cell is-col-span-3">
                <span i18n>
                    {{ matchedAnswerCount }} of {{ matchedQuestion.answers.length }} answers matched
                </span>
            </div>
            <div class="cell is-col-span-5">
                <div class="field is-grouped is-grouped-multiline">
                    <div class="control">
                        <div class="tags has-addons is-flex-wrap-nowrap">
                            <div class="tag filterable"
                                (click)="onFilterSelected($event, 'chapter', matchedQuestion.chapter.text)">
                                <span [innerHTML]="matchedQuestion.chapter | highlight"></span>
                            </div>
                            <a class="tag is-delete"
                                (click)="onExcludeFilter($event, 'chapter', matchedQuestion.chapter.text)"
                                i18n-aria-label aria-label="exclude"></a>
                        </div>
                    </div>
                    @for (subtag of matchedQuestion.subtags; track subtag.text) {
                    <div class="control">
                        <div class="tags has-addons is-flex-wrap-nowrap">
                            <div class="tag filterable" (click)="onFilterSelected($event, 'subtags', subtag.text)">
                                <span [innerHTML]="subtag | highlight"></span>
                            </div>
                            <a class="tag is-delete" (click)="onExcludeFilter($event, 'subtags', subtag.text)"
                                i18n-aria-label aria-label="exclude"></a>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@if (questionExpanded && matchedDialectNames.length) {
<div class="box mt-3" [ngClass]="{'is-loading': loading}">
    <div class="fixed-grid has-5-cols">
        <div class="grid is-column-gap-0">
            @for (dialect of matchedDialectNames; track dialect) {
            <div class="cell expanded dialect-row py-3" [id]="dialect">
                <div class="dialect-header">
                    <h3 class="subtitle mb-1">
                        <div class="tags has-addons are-large dialect-tag is-flex-wrap-nowrap">
                            <div class="tag filterable" [innerHTML]="matchedDialects[dialect][0].dialect | highlight"
                                (click)="onFilterSelected($event, 'dialect', dialect)"></div>
                            <a class="tag is-delete" (click)="onExcludeFilter($event, 'dialect', dialect)"
                                i18n-aria-label aria-label="exclude"></a>
                        </div>
                    </h3>
                    <ng-template #answerCountTag let-answerCount="answerCount">
                        <div class="tag" i18n>
                            {answerCount, plural,
                            =0 {no answers}
                            =1 {1 answer}
                            other {{{answerCount}} answers}}
                        </div>
                    </ng-template>
                    <ng-container [ngTemplateOutlet]="answerCountTag"
                        [ngTemplateOutletContext]="{ answerCount: matchedDialects[dialect].length }"></ng-container>
                </div>
            </div>
            <div class="cell is-col-start-2 is-col-span-4 expanded dialect-row">
                <div class="is-flex my-3"  *ngFor="let answer of matchedDialects[dialect]">
                    @if (answer.attestation.text === 'unattested') {
                    <span i18n class="unattested" [ngClass]="{'is-match': answer.attestation.match}">unattested</span>
                    }
                    @else {
                    <span [innerHTML]="answer.answer | highlight"></span>
                    }
                    <div class="tags ml-3 has-addons is-flex-wrap-nowrap">
                        <div class="tag filterable"
                            (click)="onFilterSelected($event, 'participantId', answer.participantId.text)">
                            <span class="icon-text">
                                <span class="icon">
                                    <fa-icon [icon]="faUser"></fa-icon>
                                </span>
                                <span [innerHTML]="answer.participantId | highlight"></span>
                            </span>
                        </div>
                        <a class="tag is-delete"
                            (click)="onExcludeFilter($event, 'participantId', answer.participantId.text)"
                            i18n-aria-label aria-label="exclude"></a>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>
}
}
